var tds = require("./index");

var util = require("util")


var date_to_ms_datetime = function(date, style) {
    var year    = date.getFullYear()
    var month   = date.getMonth()+1
    var day     = date.getDate()
    var hours   = date.getHours()
    var minutes = date.getMinutes()
    var seconds = date.getSeconds()
    
    if (style == "odbc") {
        return { year:year, month:month, day:day, hours:hours, minutes:minutes, seconds:seconds }
    }
    else {
        return util.format("%d-%d-%d %d:%d:%d", year, month, day, hours, minutes, seconds)        
    }
}

var args = {host:"192.168.1.233:1433", uid:"sa", pwd:"soholife123"}


var db = new tds.Database(args)

var db_name = "test"

var sql_str = "select top(1) * from Users;"

var sp_name = "cp_TestData_AddRecord"
var params = []

var date = date_to_ms_datetime(new Date())
console.log(date)

params[0] = {name:"@date",       type:4, size:date.length, status:0, value:date}
// params[1] = {name:"@PageSize",   type:1, size:4, status:0, value:3}
// params[2] = {name:"@RowCount",   type:1, size:4, status:1, value:2}


// http.createServer(function(request, response) {
//     db.query(db_name, sql_str, function(err, rows){
//         if(err){
//             console.log(err)
//         }

//         else {
//             for(var i in rows) {
//                 var s = ''
//                 for (var j in rows[i]) {
//                     s = s + '  ' + rows[i][j]
//                 }

//                 console.log(s)
//             }
//         }
//     })    

//     response.writeHead(200, {"Content-Type": "text/plain"});
//     response.write("Hello World");
//     response.end();
// }).listen(80);


db.call(db_name, sp_name, params, function(err, rows, result, ret_val){
    if(err){
        console.log(err)
    }

    console.log(db.conn_count)

    for(var i in rows) {
        var s = ''
        for (var j in rows[i]) {
            s = s + '  ' + rows[i][j]
        }

        console.log(s)
    }

    if(result) {
        console.log(result)
    }

    if(ret_val) {
        console.log(ret_val)
    }

    // var sql_str =
    //     "SELECT b.name, c.name AS type, b.length, b.isoutparam, b.colorder " +
    //     "FROM (SELECT * FROM sysobjects as a " +
    //     "WHERE OBJECTPROPERTY(id, N'IsProcedure') = 1 " +
    //     "AND ID = object_id(N'[dbo].[" + sp_name + "]')) AS a, " +
    //     "syscolumns b " + 
    //     "INNER JOIN dbo.systypes c ON c.xtype = b.xtype " +
    //     "WHERE a.id = b.id " +  
    //     "ORDER BY d "

    // db.query(db_name, sql_str, function(err, rows){
    //     if(err){
    //         console.log(err)
    //     }

    //     for (var i in rows) {
    //         var s = ''
    //         for (var j in rows[i]) {
    //             s = s + '  ' + rows[i][j]
    //         }

    //         console.log(s)
    //     }
        
    //     console.log(db.conn_count)
    // })

})















$(function(){select_publish_list();add_publish_category();bind_event()});
function select_publish_list(){var a=$("#publish_list_action .publish_filter ul"),b=$("#publish_list_action .filter_btn");$.ajax({url:"/publish_category/find",success:function(c){if(0!=c.ok){$.each(c,function(b,c){a.append('<li><button name="'+convert_to_blank(c.child_item)+'" data-id="'+c._id+'">'+c.name+"</button></li>")});var e=$("#publish_list_action .filter_menu button"),c=e.first();c.addClass("selected");b.html(c.html());e.click(function(){e.removeClass("selected");$(this).addClass("selected");
b.html($(this).html());a.fadeOut();find_publish_category_child($(this).data("id"))});b.click(function(b){a.fadeIn();b.preventDefault()});get_item_list_by_category(c.data("id"))}}})}function get_item_list_by_category(a){$.ajax({url:"/publish_item/find",data:{category_id:a},success:function(a){0==a.ok?alert("\u83b7\u53d6\u6570\u636e\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"):render_publish_list(a)}})}
function find_publish_category_child(a){var b=$("#publish_list_action .publish_filter ul");$.ajax({url:"/publish_category/find",data:{category_id:a},success:function(a){0==a.ok?alert("\u83b7\u53d6\u6570\u636e\u51fa\u9519"):b.find("button.selected").attr("name",convert_to_blank(a.child_item));get_item_list_by_category(b.find("button.selected").data("id"))}})}
function add_publish_category(){var a=$("#sidebar .setting .add_publish_category"),b=$("#add_publish_category_form"),c=a.find(".loading"),e=a.find(".show_result"),f=a.find(".publish_category_content input");$("#sidebar .setting button.set").click(function(){a.fadeIn()});$("#sidebar .setting .add_publish_category footer button.grey").click(function(b){b.preventDefault();a.fadeOut()});$("#sidebar .setting .add_publish_category footer input.blue").click(function(d){document.getElementById("add_publish_category_form").checkValidity()&&
($.ajax({type:"post",data:b.serialize(),url:b.attr("action"),beforeSend:function(){c.show()},success:function(){c.hide();e.show(function(){e.fadeOut(1E3,function(){f.val("");a.fadeOut(function(){location.href=location.href})})})}}),d.preventDefault())})}function createObjectURL(a){return window.URL?window.URL.createObjectURL(a):window.webkitURL?window.webkitURL.createObjectURL(a):null}
function show_or_hide_panel(a){var b=$("#save_publish_item_panel"),c=$("#detail_overlay");a?(b.show(),c.animate({left:0})):($("#item_list .item_wrapper li,#published_item_list .item_wrapper li").removeClass("editing"),c.animate({left:-394},function(){b.hide()}))}
function render_publish_list(a){function b(a){return a.thumb_url?'<li draggable="true" data-id="'+a._id+'"><span class="drag_handle"></span><a class="list_thumb_preview" href="'+a.thumb_url+'" target="_blank"><img src="'+a.thumb_url+'"/></a><a class="item_title" data-color="'+a.color+'" href="'+a.link+'">'+a.title+'</a><div class="disnone">'+convert_to_blank(a.summary)+"</div></li>":'<li draggable="true" data-id="'+a._id+'"><span class="drag_handle"></span><a class="item_title" data-color="'+convert_to_blank(a.color)+
'" href="'+a.link+'">'+a.title+'</a><div class="disnone">'+convert_to_blank(a.summary)+"</div></li>"}var c=$("#publish_list_action .publish_filter ul button.selected").attr("name");if(void 0!=c){var e=c.split(","),f=$("#published_item_list .item_wrapper"),d=$("#item_list .item_wrapper");f.empty();d.empty();var g=[];$.each(a,function(a,c){-1<e.indexOf(c._id)?g[e.indexOf(c._id)]=c:d.append(b(c))});$.each(g,function(a,c){c&&f.append(b(c))});dragg_item();edit_item()}}
function dragg_item(){$("#item_list .item_wrapper li,#published_item_list .item_wrapper li").on({dragstart:function(a){a=a.originalEvent;a.dataTransfer.setData("item",$(this).data("id"))},drop:function(a){a.stopPropagation();a.preventDefault();var a=a.originalEvent,a=a.dataTransfer.getData("item"),b=$('.item_wrapper li[data-id="'+a+'"]');$(this).data("id")!=a&&$(this).before(b)},dragenter:function(a){a.stopPropagation();a.preventDefault()},dragover:function(a){a.stopPropagation();a.preventDefault()}});
$(".section_bar").bind({drop:function(a){a.stopPropagation();a.preventDefault();var a=a.originalEvent,a=a.dataTransfer.getData("item"),a=$('.item_wrapper li[data-id="'+a+'"]'),b=$(this).next().find("ul");1>b.find("li").length&&b.append(a)},dragenter:function(a){a.stopPropagation();a.preventDefault()},dragover:function(a){a.stopPropagation();a.preventDefault()}})}function change_category_item_form_id(a){empty_category_item_form();$('#category_item_form input[name="category_id"]').val(a)}
function get_current_category_id(){return $("#publish_list_action .publish_filter ul button.selected").data("id")}function fill_category_item_form(a){var b=$("#category_item_form");b.find('input[name="item_id"]').val(a.id);b.find('input[name="title"]').val(a.title);b.find('input[name="color"]').val(a.color);b.find('input[name="link"]').val(a.link);b.find('textarea[name="summary"]').val(a.summary);b.find('input[name="thumb_url"]').val(a.thumb_url);$(".thumb_preview img").attr("src",a.thumb_url)}
function convert_to_blank(a){return void 0==a||null==a||""==a?"":a}function empty_category_item_form(){var a=$("#category_item_form");a.find('input[name="item_id"]').val("");a.find('input[name="title"]').val("");a.find('input[name="color"]').val("");a.find('input[name="link"]').val("");a.find('textarea[name="summary"]').val("");a.find('input[name="thumb_url"]').val("");$(".thumb_preview img").attr("src","");$('#category_item_form input[name="category_id"]').val("")}
function edit_item(){$("#item_list .item_wrapper .item_title, #published_item_list .item_wrapper .item_title").click(function(a){var b={id:$(this).parent().data("id"),title:$(this).html(),color:$(this).data("color"),link:$(this).attr("href"),summary:$(this).next().html(),thumb_url:$(this).prev().attr("href")};$("#item_list .item_wrapper li, #published_item_list .item_wrapper li").removeClass("editing");$(this).parent().addClass("editing");change_category_item_form_id(get_current_category_id());fill_category_item_form(b);
show_or_hide_panel(!0);a.preventDefault()})}function bind_event(){my_bind.switch_section();my_bind.save_item_list();my_bind.insert_publish_item();my_bind.save_publish_item();my_bind.trash_item();my_bind.img_load()}
var my_bind={switch_section:function(){$(".section_bar .switch_section_btn").on("click",function(){var a=$(this).parent().next();$(this).hasClass("closed")?(a.show(),$(this).removeClass("closed")):(a.hide(),$(this).addClass("closed"))})},save_item_list:function(){$("#save_publish_item_button").click(function(){var a=$("#published_item_list ul li");if(!(1>a.length)||confirm("\u53d1\u5e03\u5217\u8868\u65e0\u6570\u636e,\u786e\u8ba4\u53d1\u5e03\uff1f")){var b={category_id:get_current_category_id(),item_id_array:[]};
a.each(function(){var a=$(this).data("id");b.item_id_array.push(a)});$.ajax({type:"post",url:"/publish_category/upsert",data:b,success:function(a){1==a.ok?(alert("\u53d1\u5e03\u6210\u529f"),find_publish_category_child(b.category_id)):alert("\u53d1\u5e03\u5931\u8d25")}})}})},insert_publish_item:function(){var a=$("#insert_publish_itme_button"),b=$(".panel_action_bottom .close_panel");a.click(function(){change_category_item_form_id(get_current_category_id());show_or_hide_panel(!0)});b.click(function(a){show_or_hide_panel(!1);
a.preventDefault()})},save_publish_item:function(){var a=$("#save_publish_item_panel .panel_action input.save"),b=$("#category_item_form"),c=$("#save_publish_item_panel .panel_action .progress");a.click(function(a){document.getElementById("category_item_form").checkValidity()&&($.ajax({type:"post",data:b.serialize(),url:b.attr("action"),beforeSend:function(){c.show()},success:function(){c.html("\u4fdd\u5b58\u5b8c\u6210").fadeOut(1E3,function(){show_or_hide_panel(!1);b.find("input").val("");b.find("textarea").html("")});
get_item_list_by_category($("#publish_list_action .publish_filter ul button.selected").data("id"))}}),a.preventDefault())})},trash_item:function(){$(".panel_action_bottom .trash_item").click(function(a){var b=$('#category_item_form input[name="item_id"]').val(),c=$('#category_item_form input[name="category_id"]').val();a.preventDefault();b?0<$('#published_item_list li[data-id="'+b+'"]').length?alert("\u4e0d\u80fd\u76f4\u63a5\u5220\u9664\u5df2\u53d1\u5e03\u7684\u5185\u5bb9"):confirm("\u786e\u8ba4\u5220\u9664\uff1f")&&
$.ajax({type:"post",url:$(this).attr("href"),data:{item_id:b},success:function(a){1==a.ok?(alert("\u5220\u9664\u6210\u529f"),get_item_list_by_category(c),show_or_hide_panel(!1),empty_category_item_form()):alert("\u5220\u9664\u5931\u8d25")}}):alert("\u6ca1\u6709\u5185\u5bb9\u53ef\u5220\u9664")})},img_load:function(){var a=$('#category_item_form input[name="thumb_url"]'),b=$(".upload_img_input"),c=$(".thumb button"),e=$(".thumb .loading"),f=$(".thumb .result"),d;b.change(function(a){d=a.currentTarget.files[0];
/image/.test(d.type)?(a=createObjectURL(d),$(".thumb_preview img").attr("src",a),$(".thumb_preview .size").html(d.name+" / "+d.size/1E3+"kb")):(alert("\u8bf7\u9009\u53d6\u672c\u5730\u56fe\u7247"),a.preventDefault())});c.click(function(){var c=new FormData;d?(c.append(b.attr("name"),d),e.show(),$.ajax({type:"post",url:"/upload_file",processData:!1,contentType:!1,data:c,success:function(b){e.hide();0==b.ok?alert("\u4e0a\u4f20\u5931\u8d25"):(f.show(),f.fadeOut(2E3),a.val(b.url))}})):alert("\u6ca1\u6709\u56fe\u7247")})}};

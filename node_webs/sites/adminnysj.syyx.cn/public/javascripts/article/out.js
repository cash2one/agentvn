var controller={},editor,per_page_limit=20,article_page={all:1,unpublish:1};$(function(){editor=load_editor();add_article_category();select_article_list();bind_event(my_bind);controller.page_turn()});
function add_article_category(){var a=$("#sidebar .setting .add_article_category"),b=$("#add_article_category_form"),c=a.find(".loading"),d=a.find(".show_result"),e=a.find(".article_category_content input");$("#sidebar .setting button.set").click(function(){a.fadeIn()});$("#sidebar .setting .add_article_category footer button.grey").click(function(b){b.preventDefault();a.fadeOut()});$("#sidebar .setting .add_article_category footer input.blue").click(function(f){document.getElementById("add_article_category_form").checkValidity()&&
($.ajax({type:"post",data:b.serialize(),url:b.attr("action"),beforeSend:function(){c.show()},success:function(){c.hide();d.show().delay("1000").fadeOut(function(){e.val("");a.fadeOut(function(){location.href=location.href})})}}),f.preventDefault())})}
function select_article_list(){var a=$("#article_list_action .article_filter ul");$("#article_list_action .filter_btn");var b=$("#article_item_form ul.category_data_list");$.ajax({url:"/article_category/find",success:function(c){if(0!=c.ok){$.each(c,function(d,c){var g='<li><button data-id="'+c._id+'">'+c.name+"</button></li>";article_page[c._id]=1;a.append(g);b.append(g)});$("#article_list_action .filter_menu button").click(function(){get_article_list_by_category($(this).data("id"));a.fadeOut()});
var d=b.find("button");d.click(function(a){d.removeClass("selected");$(this).addClass("selected");$('#article_item_form input[name="category_id"]').val($(this).data("id"));$("#article_item_form a.category").html($(this).html());toggle_article_category_list();a.preventDefault()});get_article_list_by_category("all")}}})}
function get_article_list_by_category(a){var b=$("#article_list_action a.filter_btn"),c=$("#article_list_action .filter_menu button");$.ajax({url:"/articles_by_category/"+a,data:{page:parseInt(article_page[a],10)},success:function(d){if(null!=d)if(0==d.ok||0==d.total)alert("\u83b7\u53d6\u6570\u636e\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5");else{var e=$('#article_list_action .filter_menu button[data-id="'+a+'"]');b.html(e.html());c.removeClass("selected");e.addClass("selected");$(".page_turn_btn_gruop").show();
$(".page_turn_info .total").html(d.total);var e=(article_page[a]-1)*per_page_limit+1,f=e+d.list.length-1;$(".page_turn_info .current").html(e+"-"+f);render_article_list(d.list)}}})}
controller.page_turn=function(){$(".page_turn_btn_gruop button.next").click(function(){var a=get_current_category_id();console.log(get_current_category_id());var b=parseInt($(".page_turn_info .total").html());parseInt($(".page_turn_info .current").html().split("-")[1])<b?(article_page[a]=parseInt(article_page[a],10)+1,get_article_list_by_category(a)):alert("\u5df2\u662f\u6700\u540e\u4e00\u9875")});$(".page_turn_btn_gruop button.prev").click(function(){var a=get_current_category_id();parseInt($(".page_turn_info .total").html());
parseInt($(".page_turn_info .current").html().split("-")[0])>per_page_limit?(article_page[a]=parseInt(article_page[a],10)-1,get_article_list_by_category(a)):alert("\u5df2\u662f\u7b2c\u4e00\u9875")})};function show_or_hide_panel(a){var b=$("#save_article_item_panel"),c=$("#detail_overlay");a?(b.show(),c.animate({left:0})):($("#article_list .item_wrapper li").removeClass("editing"),c.animate({left:-394},function(){b.hide()}))}
function render_article_list(a){var b=$("#article_list .item_wrapper");b.empty();$.each(a,function(a,d){b.append('<li data-id="'+d._id+'"><a class="item_title" data-display_time="'+d.display_time+'" name="'+d.category_id+'" href="http://nysj.syyx.com/news_content.html?'+d._id+'">'+d.title+'</a><span class="date">'+d.display_time+"</span></li>")});edit_item()}
function toggle_article_category_list(){$("#article_item_form ul.category_data_list").slideToggle();$("#article_item_form a.category").toggleClass("open")}function get_current_category_id(){return $("#article_list_action .filter_menu button.selected").data("id")}
function empty_article_option(){var a=$("#article_item_form");a.find('input[name="category_id"]').val("");a.find('input[name="article_id"]').val("");a.find("a.title").html("");a.find("a.title").attr("href","#");a.find('input[name="display_time"]').val("");a.find("ul.category_data_list button").removeClass("selected")}
function fill_category_item_form(a){var b=$("#article_item_form");b.find('input[name="category_id"]').val(a.category_id);b.find('input[name="article_id"]').val(a.id);b.find('input[name="display_time"]').val($.browser.webkit?a.display_time.replace(/\//g,"-"):a.display_time);b.find("a.title").html(a.title);b.find("a.title").attr("href",a.link);b.find("ul.category_data_list button").each(function(){$(this).data("id")==a.category_id&&(b.find("a.category").html($(this).html()),$(this).addClass("selected"))})}
function edit_item(){$("#article_list .item_wrapper .item_title").click(function(a){var b={id:$(this).parent().data("id"),title:$(this).html(),link:$(this).attr("href"),category_id:$(this).attr("name"),display_time:$(this).data("display_time")};$("#article_list .item_wrapper li").removeClass("editing");$(this).parent().addClass("editing");empty_article_option();fill_category_item_form(b);show_or_hide_panel(!0);a.preventDefault()})}function bind_event(a){for(var b in a)a[b]()}
var my_bind={add_acticle:function(){var a=$("#edit_article");$("#save_article_item_button").click(function(b){$("#edit_article header").html("\u6dfb\u52a0\u6587\u7ae0").data("category_id","unpublish");$('#save_article_item_panel input[name="article_id"]').val("");$('#edit_article_form input[name="title"]').val("");editor.html("");a.fadeIn();b.preventDefault()});a.find("footer button.grey").click(function(){a.fadeOut()});a.find("footer input.blue").click(function(a){if(document.getElementById("edit_article_form").checkValidity()){var c=
$("#edit_article"),d=$("#edit_article_form"),e=c.find(".loading"),f=c.find(".show_result"),g=c.find("#edit_article_form input");editor.sync();$.ajax({type:"post",data:d.serialize(),url:d.attr("action"),beforeSend:function(){e.show()},success:function(){e.hide();f.show(function(){f.fadeOut(1E3,function(){g.val("");c.fadeOut()})});get_article_list_by_category($("#edit_article header").data("category_id"))}});a.preventDefault()}})},show_select_category:function(){var a=$("#article_list_action .article_filter ul");
$("#article_list_action .filter_btn").click(function(b){a.fadeIn();b.preventDefault()})},change_article_category:function(){$("#article_item_form a.category").click(function(a){toggle_article_category_list();a.preventDefault()})},save_article_option:function(){var a=$("#save_article_item_panel .panel_action input.save"),b=$("#article_item_form"),c=$("#save_article_item_panel .panel_action .progress");a.click(function(a){document.getElementById("article_item_form").checkValidity()&&($.ajax({type:"post",
data:b.serialize(),url:b.attr("action"),beforeSend:function(){c.show()},success:function(){c.html("\u4fdd\u5b58\u5b8c\u6210").fadeOut(1E3,function(){show_or_hide_panel(!1);b.find("input").val("")});get_article_list_by_category($('#article_item_form input[name="category_id"]').val())}}),a.preventDefault())})},edit_article:function(){$("#article_item_form a.edit_article").click(function(a){var b=$('#save_article_item_panel input[name="article_id"]').val(),c=$('#save_article_item_panel input[name="category_id"]').val();
$("#edit_article header").html("\u7f16\u8f91\u6587\u7ae0").data("category_id",c);$("#edit_article").fadeIn();$('#edit_article_form input[name="article_id"]').val(b);$.ajax({url:"/article/"+b,success:function(a){$('#edit_article_form input[name="title"]').val(a.title);editor.html(a.text)}});a.preventDefault()})},close_panel:function(){$(".panel_action_bottom .close_panel").click(function(a){show_or_hide_panel(!1);a.preventDefault()})},trash_article:function(){$(".panel_action_bottom .trash_item").click(function(a){var b=
$('#article_item_form input[name="article_id"]').val(),c=$('#article_item_form input[name="category_id"]').val();a.preventDefault();b?confirm("\u786e\u8ba4\u5220\u9664\uff1f")&&$.ajax({type:"delete",url:$(this).attr("href")+b,success:function(a){1==a.ok?(alert("\u5220\u9664\u6210\u529f"),get_article_list_by_category(c),show_or_hide_panel(!1)):alert("\u5220\u9664\u5931\u8d25")}}):alert("\u6ca1\u6709\u5185\u5bb9\u53ef\u5220\u9664")})},search_article:function(){$("#search_article_input").keypress(function(a){if(13==
a.which){if(document.getElementById("search_article_form").checkValidity()){$("#article_list_action .filter_menu button.selected").data("id");$(this).val();var b=$("#search_article_form");$.ajax({url:b.attr("action"),data:b.serialize(),success:function(a){1>a.length?(alert("\u6ca1\u6709\u7ed3\u679c"),$("#search_article_input").focus()):($(".page_turn_btn_gruop").hide(),render_article_list(a))}})}a.preventDefault()}})}};
function load_editor(){var a=KindEditor.create("#article_text",{cssPath:"http://s.syyx.com.cn/plugins/kindeditor/plugins/code/prettify.css",uploadJson:"/kind_editor_upload_img",items:"source,justifyleft,justifycenter,justifyright,fontsize,forecolor,bold,underline,image,link,unlink".split(",")});$("#edit_article").hide();$("#edit_article").css("visibility","visible");return a};

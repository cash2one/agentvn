//---------------------------------------------------------------------------------------------------------// captch.js//---------------------------------------------------------------------------------------------------------var CHARACTERS = 'ABHMNSWY'//--------------------------------------------------------------------------------------------------------var captcha_buffer = []var buffer_length  = 100var font_file      = process.env['HOME'] + "/syyx_conf/font/msyh.ttf"//--------------------------------------------------------------------------------------------------------exports.refresh_flag = true //--------------------------------------------------------------------------------------------------------exports.create_captcha = function(cb) {    if(captcha_buffer.length >= buffer_length) {        var index = ms.u2.random_int(0, captcha_buffer.length - 1)        var captcha = captcha_buffer[index]        cb(captcha.code, captcha.data)        return    }    var code = rendom_captcha_code(4, CHARACTERS)        ms.gd.create_captcha(300, 60, code, 1, font_file, function(img) {        code = code.toLocaleLowerCase()        var data = new Buffer(img, encoding='binary')        captcha_buffer.push({ code : code, data : data })                cb(code, data)    })       }//--------------------------------------------------------------------------------------------------------function rendom_captcha_code(len, charset) {    var code = ''    for(var i = 0; i < len; i++) {        var index = ms.u2.random_int(0, charset.length - 1)        code = code + charset.charAt(index)    }    return code}//--------------------------------------------------------------------------------------------------------function refresh_captcha_buffer() {    setInterval(function() {        if (exports.refresh_flag && captcha_buffer.length >= buffer_length) {            captcha_buffer = []        }    }, 10 * 60 * 1000)}//---------------------------------------------------------------------------------------------------------function init() {    refresh_captcha_buffer()}//---------------------------------------------------------------------------------------------------------init()//---------------------------------------------------------------------------------------------------------
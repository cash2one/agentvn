//--------------------------------------------------------------------------------------------------------
// get_card.js
//--------------------------------------------------------------------------------------------------------
var all_card_type = [
    "17173",
    "网吧",
    "联盟",
    "多玩",
    "360",
]

var card_type_map = {
    "index_173"        : 0,

    "index5"           : 1,
    "index8"           : 1,
    "index_i8"         : 1,
    "index_sw"         : 1,
    "index_yy"         : 1,
    "index_xs"         : 1,

    "index_i8_embed"   : 1,    
    "index_sw_embed"   : 1,
    "index_sw_1"       : 1,
    "netbarclient"     : 1,
    "netbarclient_reg" : 1,

    "index_zfgc"       : 2,
    "index40"          : 2,
    "index_xq"         : 2,
    "index31"          : 2,
    "index_sg"         : 2,
    "index_nycs"       : 2,
    "index"            : 2,
    "index35"          : 2,
    "index34"          : 2,
    "index32"          : 2,
    "index_bd"         : 2,
    "index_bd_1"       : 2,
    "gameFeature"      : 2,
    "index_17173"      : 2,
    "index_duowan"     : 2,
    "index_sina"       : 2,
    "index_xunlei"     : 2,
    "index_xlzt"       : 2,

    "index_dw"         : 3,
    "index_360"        : 4
}

function get_card_type(page_name) {
    var page_name    = page_name.replace(/nycs_/, "")
    var card_type_id = card_type_map[page_name]
    if (typeof card_type_id !== 'number') {
        return
    }

    return all_card_type[card_type_id]
}
//-获取卡号-------------------------------------------------------------------------------------------------------
exports.apply_card = function(account, client_ip, page_name, cb) {
    var card_type = get_card_type(page_name)
    if (!card_type) {
        return false
    }

    var db      = ms.db.mssql['Game_Fushe_Sport']
    var sp_name = 'cp_Events_Stock_GetRecordInfo'
    var args    = [ account, client_ip, card_type ]

    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        if (output) {
            var card = output['@CardName']
            if (!card) {
                cb('error: no card')
            }
            else {
                cb(null, card)
            }

            return
        }

        cb(err)
    })

    return true
}

//-验证卡号-------------------------------------------------------------------------------------------------------
exports.check_card = function(card, cb) {

    var date = ms.u2.date_to_ms_datetime(new Date(), 'tds')
   
    var db      = ms.db.mssql['ShangYoo_GS']
    var sp_name = 'cp_GSCardList_IsCardActive'
    var args    = [ card, 1, "NewUserCard"]

    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        cb(ret)
    })
    return
}


//-激活卡号-------------------------------------------------------------------------------------------------------
exports.activate = function(account, card, cb) {

    var date = ms.u2.date_to_ms_datetime(new Date(), 'tds')

    var db      = ms.db.mssql['NYCS_GiftActivate']
    var sp_name = 'cp_UserNewCard_AddRecord'
    var args    = [ account, card, date, 1]

    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        cb(ret)
    })
    return
}


//--------------------------------------------------------------------------------------------------------
test_card = function() {
    var db      = ms.db.mssql['Game_Fushe_Sport']
    var sp_name = 'cp_Events_Stock_GetRecordInfo'
    var args    = [ '101010', '192.168.2.1', '网吧' ]

    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        console.log(err)
        console.log(rows)
        console.log(output)
        console.log(ret)
    })
}
//--------------------------------------------------------------------------------------------------------

//---------------------------------------------------------------------------------------------------------
// mongo_interface.js
//---------------------------------------------------------------------------------------------------------
var mongo      = require('mongodb')
var Db         = mongo.Db
var Server     = mongo.Server
//---------------------------------------------------------------------------------------------------------
exports.open = function(args, cb) {
    var ip         =  args.ip
    var port       =  args.port
    var db_name    =  args.db_name
    var user       =  args.user
    var password   =  args.password      

    var server     =  new Server(ip, port, { auto_reconnect : true }, {})
    var db         =  new Db(db_name, server, { native_parser : true })

    db.open(function(err, db) {
        if(err) {
            console.log("open mongodb failed : " + err)
            cb(err)
            return 
        }
        
        if(user && password) {
            db.authenticate(user, password, function(err){
                if(err) {
                    console.log("authenticate failed : " + err)
                }
                
                cb(err, db)
            })
        }
        
        else {
            cb(err, db)
        }            
    })
}
//---------------------------------------------------------------------------------------------------------
exports.save = function(db, db_name, col_name, data, cb) {
    var database = db.db(db_name)

    database.collection(col_name, function(err, collection) {
        if (data._id) {
            var method = 'save'
        }
        else {
            var method = 'insert'
        }

        collection[method](data, function(err, doc) {
            cb && cb(err, doc)
        }) 
    })    
}
//---------------------------------------------------------------------------------------------------------
exports.findOne = function(db, db_name, col_name, selector, options, cb) {
    var database = db.db(db_name)

    database.collection(col_name, function(err, collection) {
        collection.findOne(selector, options, function(err, doc) {
            cb && cb(err, doc)
        })        
    })    
}
//---------------------------------------------------------------------------------------------------------
exports.find = function(db, db_name, col_name, selector, options, cb) {
    var database = db.db(db_name)

    database.collection(col_name, function(err, collection) {
        collection.find(selector, options).toArray(function(err, docs){
            cb && cb(err, docs)
        })        
    })    
}
//---------------------------------------------------------------------------------------------------------
exports.update = function(db, db_name, col_name, selector, document, cb) {
    var database = db.db(db_name)

    database.collection(col_name, function(err, collection) {
        collection.update(selector, { '$set' : document}, function(err) {
            cb && cb(err)
        })        
    })    
}
//---------------------------------------------------------------------------------------------------------
exports.remove = function(db, db_name, col_name, selector, cb) {
    var database = db.db(db_name)

    database.collection(col_name, function(err, collection) {
        collection.remove(selector, function(err, data) {
            cb && cb(err, data)
        })        
    })    
}
//---------------------------------------------------------------------------------------------------------
exports.ObjectID = mongo.ObjectID
//---------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------------------------
// sms.js
//-------------------------------------------------------------------------------------------------
exports.init = function(account, password) {
    var sp = new ms.events.EventEmitter()
    sp.account = account
    sp.password = password
    
    return sp
}
//-------------------------------------------------------------------------------------------------
exports.send = function(sp, phone_numbers, msg, cb) {
    var phone_number_count = phone_numbers.split(',').length
    if (phone_number_count <= 0) {
        cb('no number'); return
    }

    var args = { userId : sp.account, password : sp.password }
    ms.ws.montnets.MongateQueryBalance(args, function(e, r) {
        if (e) {
            cb(e); return
        }

        if (!r) {
            cb('no result'); return
        }

        if (r.MongateQueryBalanceResult <= 0) {
            cb('no money'); return
        }

        args.pszMobis   = phone_numbers
        args.pszMsg     = msg
        args.iMobiCount = phone_number_count
        args.pszSubPort = '*'
        
        ms.ws.montnets.MongateCsSpSendSmsNew(args, function(e, r) {
            cb(e, r)
        })
    })
}
//-------------------------------------------------------------------------------------------------
function recv(sp) {
    var args = { userId : sp.account, password : sp.password }
    ms.ws.montnets.MongateCsGetSmsExEx(args, function(e, r) {
        if (e) {
            console.error(e); 
            return
        }

        if (!r) { 
            console.error('no recv ret')
            return
        }

        if (!r.MongateCsGetSmsExExResult) {
            console.error('no recv result')
            return
        }

        var recv_obj = r.MongateCsGetSmsExExResult[0]
        if (!recv_obj) {
            console.error('no recv object')
            return
        }

        var recv_str = recv_obj.string
        if (!recv_str) {
            console.error('no recv string')
            return
        }

        sp.emit('data', recv_str)
    })
}

function process_recv(recv_str) {
    var result = []

    for (var i = 0; i < recv_str.length; ++i) {
        var str = recv_str[i]
        var info = str.split(',')

        var r = {}
        r.date = info[0]
        r.time = info[1]
        r.sender = info[2]
        r.channel = info[3]
        r.msg = info[5]

        result.push(r)
    }

    return result
}
//-------------------------------------------------------------------------------------------------
exports.start_recv = function(sp, interval, cb) {
    sp.stop_recv = false

    sp.on('data', function(recv_str) {
        if (!recv_str) {
            return
        }
        
        if (cb) {
            var recv_info = process_recv(recv_str)
            cb(recv_info)
        }
    })

    var id = setInterval(function() {
        if (sp.stop_recv) {
            sp.stop_recv = false
            clearInterval(id)
            return
        }

        recv(sp)
    }, interval * 1000)
}
//-------------------------------------------------------------------------------------------------
exports.stop_recv = function(sp) {
    sp.stop_recv = true
}
//-------------------------------------------------------------------------------------------------
exports.report = function(sp, cb) {
    var args = { userId : sp.account, password : sp.password }
    ms.ws.montnets.MongateCsGetStatusReportExEx(args, function(e, r) {
        if (e) {
            console.error(e); 
            return
        }

        if (!r) { 
            console.error('no report ret')
            return
        }

        if (!r.MongateCsGetStatusReportExExResult) {
            console.error('no report result')
            return
        }

        console.log(r.MongateCsGetStatusReportExExResult)

        if (cb) {
            cb(r.MongateCsGetStatusReportExExResult)
        }
    })
}
//-------------------------------------------------------------------------------------------------
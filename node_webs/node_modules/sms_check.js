//-------------------------------------------------------------------------------------------------------
/*
功能：  生成短信验证码
参数：  phone：账号
		type： 生成验证码的类型
响应：  0、成功并返回AppID
        1、数据库操作失败
        2、发送验证码超过5次
*/
exports.create = function(phone, type, ip, cb) {
    var db      = ms.db.mssql['ShangYoo_Mobile']    
    var sp_name = 'cp_MsgList_AddAppRecord'

    if (!db) {        
        console.error('db not connected')
        cb(1, '')
    }

    var validatecode = Math.ceil(Math.random()*(999999-100000)+100000)
    //msgtype:bindingapp
    var args = [ phone, validatecode , type, ip]
    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        if (err) {
            console.error(err)
            cb(1, '')
            return
        }
        
        if(ret == -1){     
            console.error('over 25 times')
            cb(2, '') 
            return
        }
        
        cb(0, validatecode)
    })
}
//-------------------------------------------------------------------------------------------------------
/*
功能：  验证手机验证码
参数：  phone:   电话号码
		type：   生成验证码的类型
		code：	 验证码
响应：  0、成功并返回AppID
        1、数据库操作失败
        2、用户未绑定手机
        3、验证码无效
*/
exports.check = function(phone, type, code, cb) {
    var db      = ms.db.mssql['ShangYoo_Mobile']  
    var sp_name = 'cp_MsgList_CheckAuthcode'

    if (!db) {        
        console.error('db not connected')
        cb(1)
        return
    }

    var args = [ phone, type, code ]
    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        if (err) {
            console.error(err)
            cb(1)
            return
        }
        
        if(ret == -1 ){     
            console.error('account no bingding phone')
            cb(2) 
            return
        }
        
        if(ret == -2){
            console.error('captcha is expirationtime or error')
            cb(3)
            return
        } 

        cb(0)
    })
}
//-------------------------------------------------------------------------------------------------------
/*
功能：  设置验证码已使用
参数：  phone：电话号码
        code： 验证码
响应：  0、成功并返回AppID
        1、操作失败
*/
exports.update = function(phone, code, cb) {
    var db      = ms.db.mssql['ShangYoo_Mobile']  
    var sp_name = 'cp_MsgList_UpdateRecord'

    if (!db) {        
        console.error('db not connected')
        cb(1)
        return
    }
    var date = ms.u2.date_to_ms_datetime(new Date(), 'tds')
    var args = [ phone, code, date]
    db.exec_sp(sp_name, args, function(err, rows, output, ret) {
        if (err) {
            console.error(err)
            cb(1)
            return
        }

        cb(0)
    })
}
//-------------------------------------------------------------------------------------------------------
//--------------------------------------------------------------------------------------------------------
// email.js
//--------------------------------------------------------------------------------------------------------
var nodemailer = require('nodemailer')
//--------------------------------------------------------------------------------------------------------
exports.create_sender = function(smtp_host, smtp_port, use_ssl, sender_mail, sender_pass) {
    var transport = nodemailer.createTransport("SMTP", {
        host : smtp_host, // "173.194.79.109", // smtp.gmail.com", // hostname
        port : smtp_port, // 465, // port for secure SMTP
        
        auth : {
            user : sender_mail,
            pass : sender_pass,
        },

        secureConnection : use_ssl, // true, // use SSL
    })

    transport.send = function(from, to, subject, content, attachments, cb) {
        var sender = this

        var mailOptions = {
            from    : from,
            to      : to,
            subject : subject,
            text    : content.text,
            html    : content.html,
        }

        attachments = make_attachments(attachments)
        if (attachments) {
            mailOptions.attachments = attachments
        }

        sender.sendMail(mailOptions, function(error, response) {
            cb(error, response)

            if (error) {
                console.log(error)
            }
            else {
                console.log(from + ' send email to ' + to + ' ' + response.message)
            }
        })
    }

    return transport
}
//--------------------------------------------------------------------------------------------------------
function make_attachments(attachments) {
    var results = []

    for (var i in attachments) {
        var file_path  = attachments[i]
        if (!file_path) {
            continue
        }

        var path_array = file_path.split('/')
        var file_name  = path_array[path_array.length - 1]

        var attachment = {
            fileName : file_name,
            filePath : file_path,
        }

        results.push(attachment)
    }

    if (results.length > 0) {
        return results
    }
        
    return
}
//--------------------------------------------------------------------------------------------------------
// unittest block
var ut = require('unittest')
ut.unittest(__filename, [
    {   
        name : 'test_make_attachments_01',
        func : function() {
            var r = make_attachments(['/abc/hello.a', '/xyz/world.b'])

            ut.ok(r.length == 2)
            ut.ok(r[0].fileName == 'hello.a')
            ut.ok(r[0].filePath == '/abc/hello.a')
            ut.ok(r[1].fileName == 'world.b')
            ut.ok(r[1].filePath == '/xyz/world.b')
        },
    },
    {   
        name : 'test_make_attachments_02',
        func : function() {
            var r = make_attachments(['/hello.a', 'world.b'])

            ut.ok(r.length == 2)
            ut.ok(r[0].fileName == 'hello.a')
            ut.ok(r[0].filePath == '/hello.a')
            ut.ok(r[1].fileName == 'world.b')
            ut.ok(r[1].filePath == 'world.b')
        },
    },
    {   
        name : 'test_make_attachments_03',
        func : function() {
            var r = make_attachments()

            ut.ok(r == undefined)
        },
    },
    {   
        name : 'test_make_attachments_04',
        func : function() {
            var r = make_attachments([])

            ut.ok(r == undefined)
        },
    },
    {   
        name : 'test_make_attachments_05',
        func : function() {
            var r = make_attachments([''])

            ut.ok(r == undefined)
        },
    },
])
//--------------------------------------------------------------------------------------------------------